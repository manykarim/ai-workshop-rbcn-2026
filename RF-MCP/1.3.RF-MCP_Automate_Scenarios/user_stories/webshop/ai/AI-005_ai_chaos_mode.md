# AI-005: AI Chaos Mode

| Field       | Value                                                    |
|-------------|----------------------------------------------------------|
| **Story ID**  | AI-005                                                 |
| **Title**     | AI Chaos Mode                                          |
| **Priority**  | Medium                                                 |
| **Component** | AI Concierge API, Workshop Presets, Workshop Flags      |
| **Labels**    | ai, testing, chaos, non-determinism, workshop, preset  |

## User Story

**As a** workshop facilitator,
**I want to** enable "AI chaos mode",
**So that** participants experience combined non-determinism.

## Acceptance Criteria

### AC-1: Apply ai_chaos preset

**Given** the workshop API is available
**When** a POST request is sent to `/api/workshop/preset` with `{"preset": "ai_chaos"}`
**Then** the response status is `200 OK`
**And** the response confirms the preset was applied successfully

### AC-2: Preset sets correct flag combination

**Given** the `"ai_chaos"` preset has been applied
**When** the workshop status is checked via `GET /api/workshop/status`
**Then** the following flags are set:
  - `AI_DETERMINISTIC` = `false`
  - `AI_RANDOM_DELAYS` = `true`
  - `AI_VARIED_RESPONSES` = `true`

### AC-3: Responses have variable delays

**Given** the `"ai_chaos"` preset is active
**When** multiple questions are submitted to `POST /api/ai/ask`
**Then** each response is delayed by a random duration between 0.5 and 2.0 seconds
**And** response times vary between requests

### AC-4: Response templates rotate between 5 variants

**Given** the `"ai_chaos"` preset is active
**When** multiple different questions are submitted
**Then** the mock LLM uses different response templates from the pool of 5
**And** summaries contain varied phrasings (e.g., "Based on your question", "Great question about", "Looking at", "our catalogue suggests", "Regarding")

### AC-5: Live LLM used when API key is configured

**Given** the `"ai_chaos"` preset is active
**And** a valid AI API key is configured in the environment
**When** a question is submitted
**Then** the response `provider` field may be `"openai"` (or the configured provider)
**And** the response is generated by the real LLM, which is non-deterministic by nature
**And** `workshop_flags.deterministic` is `false`

### AC-6: Mock fallback when no API key is configured

**Given** the `"ai_chaos"` preset is active
**And** no AI API key is configured
**When** a question is submitted
**Then** the response `provider` is `"mock"`
**And** the mock still provides varied templates and random delays

### AC-7: Workshop status reflects ai_mode change

**Given** the workshop was in the default "clean" preset (deterministic mode)
**When** the `"ai_chaos"` preset is applied
**Then** the workshop status `ai_mode` changes from `"deterministic"` to a value containing `"varied"` and/or `"delayed"`
**And** the format is `"live (delayed, varied)"` or `"deterministic (delayed, varied)"` depending on API key availability

### AC-8: Combined non-determinism in responses

**Given** the `"ai_chaos"` preset is active
**When** the same question `"What headphones do you have?"` is submitted 5 times
**Then** responses may have different timing (varying delays)
**And** responses may have different summary phrasing (template rotation)
**And** response structure (fields and types) remains consistent across all responses

## Example Request / Response

### Applying the Preset

```http
POST /api/workshop/preset
Content-Type: application/json

{
  "preset": "ai_chaos"
}
```

### Preset Response

```json
{
  "status": "success",
  "preset": "ai_chaos",
  "applied_flags": {
    "AI_DETERMINISTIC": false,
    "AI_RANDOM_DELAYS": true,
    "AI_VARIED_RESPONSES": true
  },
  "current_status": {
    "locator_stage": "v1",
    "active_bugs": [],
    "ai_mode": "live (delayed, varied)"
  }
}
```

### Workshop Status After Preset

```http
GET /api/workshop/status
```

```json
{
  "locator_stage": "v1",
  "active_bugs": [],
  "ai_mode": "live (delayed, varied)",
  "all_flags": {
    "AI_DETERMINISTIC": false,
    "AI_RANDOM_DELAYS": true,
    "AI_VARIED_RESPONSES": true,
    "LOCATOR_V2": false,
    "LOCATOR_V3": false,
    "LOCATOR_V4": false,
    "BUG_MISSING_BUTTON": false,
    "BUG_WRONG_PRICE": false,
    "BUG_BROKEN_LINKS": false,
    "BUG_SLOW_RESPONSE": false
  }
}
```

### AI Response in Chaos Mode (example -- will vary)

```json
{
  "question": "What headphones do you have?",
  "mode": "summary",
  "provider": "mock",
  "answer": {
    "product": "Catalogue Overview",
    "summary": "(Mock) Looking at 'What headphones do you have?', I'd recommend: Product: Aurora Neural Headphones",
    "price": null,
    "highlights": [
      "Product: Aurora Neural Headphones",
      "Category: Audio",
      "Price: $249.99"
    ]
  },
  "context_used": "Product: Aurora Neural Headphones\nCategory: Audio\nPrice: $249.99\nDescription: ...",
  "prompt_header": "Mode: summary | Question: What headphones do you have?",
  "workshop_flags": {
    "deterministic": false,
    "varied": true,
    "delayed": true
  }
}
```

## Test Data

| Attribute                 | Value                                           |
|---------------------------|-------------------------------------------------|
| Preset name               | `"ai_chaos"`                                    |
| AI_DETERMINISTIC          | false                                           |
| AI_RANDOM_DELAYS          | true                                            |
| AI_VARIED_RESPONSES       | true                                            |
| Delay range               | 0.5 - 2.0 seconds                               |
| Template count            | 5                                               |
| ai_mode (no API key)      | `"live (delayed, varied)"`                      |
| ai_mode (with API key)    | `"live (delayed, varied)"`                      |

### Reverting to Clean State

```http
POST /api/workshop/preset
Content-Type: application/json

{
  "preset": "clean"
}
```

## Notes

- This is the hardest mode for test automation. Participants must handle both timing variation and content variation simultaneously.
- Recommended test strategies for chaos mode:
  - **Structure-based assertions**: Validate field presence and types rather than exact values. Assert `answer.summary` is a non-empty string, not a specific string.
  - **Content-based assertions**: Check that `answer.summary` contains the original question or known product names rather than matching the full text.
  - **Timeout management**: Set generous timeouts (5-10 seconds) to accommodate maximum delay.
  - **Retry logic**: Implement retry mechanisms for timing-sensitive validations.
  - **Schema validation**: Use JSON Schema or equivalent to validate response structure.
- The `"ai_chaos"` preset only modifies AI-related flags. Locator and bug flags are unaffected and retain their current values.
- When a real API key is configured with `AI_DETERMINISTIC=false`, the actual LLM generates responses. These are inherently non-deterministic -- the same question may produce different answers on each call. This most closely simulates production behavior.
- To reset to stable testing mode, apply the `"clean"` preset which sets `AI_DETERMINISTIC=true` and disables delays and variation.
- Workshop facilitators should introduce chaos mode after participants have mastered deterministic testing (AI-002) and individual variation features (AI-003, AI-004).
